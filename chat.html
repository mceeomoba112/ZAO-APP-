<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAO APP - Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="enhanced-modal-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="whatsapp-container">
        <!-- Left Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="user-profile-section">
                    <div class="user-avatar" id="userAvatar">
                        <img id="userProfileImage" style="display: none;" />
                        <i class="fas fa-user" id="defaultUserIcon"></i>
                    </div>
                    <div class="user-info">
                        <h3 id="currentUserName">User</h3>
                        <span class="online-status">
                            <i class="fas fa-circle"></i> Online
                        </span>
                    </div>
                </div>
                <!-- Removed all top header action buttons -->
            </div>

            

            <div class="chat-list-section">
                <div class="chats-container" id="contactsList">
                    <div class="no-chats-placeholder">
                        <div class="placeholder-content">
                            <i class="fas fa-comments placeholder-icon"></i>
                            <h3>No chats yet</h3>
                            <p>Start a conversation by adding a contact</p>
                            <button class="start-chat-btn" onclick="showAddContactModal()">
                                <i class="fas fa-plus"></i> Start New Chat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-conversation">
            <div class="chat-header">
                <div class="chat-contact-info">
                    <div class="contact-avatar" id="currentChatAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="contact-details">
                        <h4 id="currentChatUser">Select a chat</h4>
                        <span id="contactStatus">Choose someone to start messaging</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="welcome-screen">
                    <div class="welcome-content">
                        <div class="zao-logo">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h2>Welcome to ZAO APP</h2>
                        <p>Select a chat to start messaging or add a new contact to begin</p>
                    </div>
                </div>
            </div>

            <div class="message-input-container">
                <div class="message-input-wrapper">
                    <button class="input-action-btn" onclick="toggleEmojiPicker()" title="Add emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button class="input-action-btn" onclick="openPhotoSelector()" title="Send photo">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="input-action-btn" onclick="openVideoSelector()" title="Send video">
                        <i class="fas fa-video"></i>
                    </button>
                    <div class="message-input-field">
                        <input type="text" id="messageInput" placeholder="Select a chat to start messaging..." disabled onkeypress="handleEnterKey(event)">
                    </div>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Media Preview Area -->
                <div class="media-preview-container" id="mediaPreview" style="display: none;">
                    <div class="media-preview-content">
                        <div class="preview-header">
                            <span>Media Preview</span>
                            <button class="close-preview" onclick="closeMediaPreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="preview-media" id="previewMedia"></div>
                        <div class="preview-actions">
                            <button class="cancel-media" onclick="closeMediaPreview()">Cancel</button>
                            <button class="send-media" onclick="sendMediaMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Add Contact Modal -->
    <div id="addContactModal" class="premium-modal hidden">
        <div class="premium-modal-overlay" onclick="closeModal('addContactModal')"></div>
        <div class="premium-modal-content add-contact-modal-enhanced">
            <div class="modal-glow-effect"></div>
            <div class="premium-modal-header">
                <div class="modal-title-section">
                    <div class="title-icon-wrapper">
                        <i class="fas fa-user-plus"></i>
                        <div class="icon-pulse"></div>
                    </div>
                    <div class="title-content">
                        <h3>Add New Contact</h3>
                        <p>Connect with friends on ZAO APP</p>
                    </div>
                </div>
                <button class="premium-modal-close" onclick="closeModal('addContactModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="premium-modal-body">
                <div class="add-contact-options-enhanced">
                    <div class="contact-option-enhanced email-option" onclick="showEmailInput()">
                        <div class="option-background"></div>
                        <div class="option-icon-enhanced email-gradient">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="option-content-enhanced">
                            <h4>Add by Email</h4>
                            <p>Enter their email address</p>
                        </div>
                        <div class="option-arrow-enhanced">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="contact-option-enhanced username-option" onclick="showUsernameInput()">
                        <div class="option-background"></div>
                        <div class="option-icon-enhanced username-gradient">
                            <i class="fas fa-at"></i>
                        </div>
                        <div class="option-content-enhanced">
                            <h4>Add by Username</h4>
                            <p>Enter their ZAO username</p>
                        </div>
                        <div class="option-arrow-enhanced">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>

                <div class="email-input-section-enhanced hidden" id="emailInputSection">
                    <div class="input-header">
                        <button class="back-button" onclick="hideEmailInput()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-text">
                            <h4><i class="fas fa-envelope"></i> Add by Email</h4>
                            <p>Enter the email address of the person you want to add</p>
                        </div>
                    </div>
                    <div class="premium-input-wrapper-enhanced">
                        <div class="input-icon-enhanced">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <input type="email" id="contactEmail" placeholder="Enter email address">
                        <div class="input-border-enhanced"></div>
                    </div>
                    <div class="modal-buttons-enhanced">
                        <button class="btn-primary-enhanced" onclick="addContactByEmail()">
                            <div class="btn-glow-enhanced"></div>
                            <i class="fas fa-plus"></i>
                            <span>Add Contact</span>
                        </button>
                    </div>
                </div>

                <div class="username-input-section-enhanced hidden" id="usernameInputSection">
                    <div class="input-header">
                        <button class="back-button" onclick="hideUsernameInput()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-text">
                            <h4><i class="fas fa-at"></i> Add by Username</h4>
                            <p>Enter their ZAO username to connect</p>
                        </div>
                    </div>
                    <div class="premium-input-wrapper-enhanced">
                        <div class="input-icon-enhanced">
                            <i class="fas fa-at"></i>
                        </div>
                        <input type="text" id="contactUsername" placeholder="ZAO-USERNAME">
                        <div class="input-border-enhanced"></div>
                    </div>
                    <div class="modal-buttons-enhanced">
                        <button class="btn-primary-enhanced" onclick="addContactByUsername()">
                            <div class="btn-glow-enhanced"></div>
                            <i class="fas fa-plus"></i>
                            <span>Add Contact</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="photoInput" style="display: none;" accept="image/*" onchange="handlePhotoUpload(this)">
    <input type="file" id="videoInput" style="display: none;" accept="video/*" onchange="handleVideoUpload(this)">

    <!-- Bottom navigation removed from chat page -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script type="module" src="script.js"></script>

    <script>
        // Global variables for media handling
        let selectedMedia = null;

        // Initialize selected contact on page load
        document.addEventListener('DOMContentLoaded', () => {
            const selectedContact = localStorage.getItem('selectedContact');
            if (selectedContact) {
                try {
                    const contact = JSON.parse(selectedContact);
                    setTimeout(() => {
                        if (window.openDirectChat) {
                            window.openDirectChat(contact);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error loading selected contact:', error);
                }
                localStorage.removeItem('selectedContact');
            }
        });

        function openPhotoSelector() {
            document.getElementById('photoInput').click();
        }

        function openVideoSelector() {
            document.getElementById('videoInput').click();
        }

        function handlePhotoUpload(input) {
            const file = input.files[0];
            if (file) {
                selectedMedia = { file, type: 'image' };
                showMediaPreview(file, 'image');
            }
        }

        function handleVideoUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 50 * 1024 * 1024) { // 50MB limit
                    alert('Video file too large. Please select a video smaller than 50MB.');
                    return;
                }
                selectedMedia = { file, type: 'video' };
                showMediaPreview(file, 'video');
            }
        }

        function showMediaPreview(file, type) {
            const previewContainer = document.getElementById('mediaPreview');
            const previewMedia = document.getElementById('previewMedia');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'image') {
                    previewMedia.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                } else if (type === 'video') {
                    previewMedia.innerHTML = `<video src="${e.target.result}" controls style="max-width: 200px; max-height: 200px; border-radius: 8px;"></video>`;
                }
            };
            reader.readAsDataURL(file);
            
            previewContainer.style.display = 'block';
        }

        function closeMediaPreview() {
            document.getElementById('mediaPreview').style.display = 'none';
            selectedMedia = null;
            // Reset file inputs
            document.getElementById('photoInput').value = '';
            document.getElementById('videoInput').value = '';
        }

        async function sendMediaMessage() {
            if (!selectedMedia || !window.currentConversation) {
                alert('No media selected or no active conversation');
                return;
            }

            try {
                // Show uploading state
                const sendButton = document.querySelector('.send-media');
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                sendButton.disabled = true;

                // Upload media using the existing uploadMedia function
                if (window.uploadMedia) {
                    const mediaUrl = await window.uploadMedia(selectedMedia.file);
                    
                    if (mediaUrl) {
                        // Send message with media URL
                        await sendMessageWithMedia(mediaUrl, selectedMedia.type);
                        closeMediaPreview();
                    } else {
                        alert('Failed to upload media. Please try again.');
                    }
                } else {
                    alert('Media upload functionality not available');
                }
            } catch (error) {
                console.error('Error sending media:', error);
                alert('Failed to send media. Please try again.');
            } finally {
                // Reset button state
                const sendButton = document.querySelector('.send-media');
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                sendButton.disabled = false;
            }
        }

        async function sendMessageWithMedia(mediaUrl, mediaType) {
            if (!window.currentConversation || !window.currentUser) return;

            try {
                // Import supabase
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
                const supabase = createClient('https://crmyrtgyxbmkhlzctapu.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNybXlydGd5eGJta2hsemN0YXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTEwODcsImV4cCI6MjA3MTA4NzA4N30.bbj-zsXgJU-FBMCTs_WLfk0JYiydkhmr--O2b9Iiqbc');

                const { data: messageData, error: messageError } = await supabase
                    .from('messages')
                    .insert({
                        sender_id: window.currentUser.id,
                        receiver_id: window.currentConversation.id,
                        content: mediaType === 'image' ? '📷 Photo' : '🎥 Video',
                        message_type: mediaType,
                        media_url: mediaUrl
                    })
                    .select()
                    .single();

                if (messageError) throw messageError;

                // Update conversation
                await supabase
                    .from('conversations')
                    .upsert({
                        user1_id: window.currentUser.id < window.currentConversation.id ? window.currentUser.id : window.currentConversation.id,
                        user2_id: window.currentUser.id < window.currentConversation.id ? window.currentConversation.id : window.currentUser.id,
                        last_message_id: messageData.id,
                        updated_at: new Date().toISOString()
                    });

                // Reload messages
                if (window.loadMessages) {
                    await window.loadMessages(window.currentConversation.id);
                }

            } catch (error) {
                console.error('Error sending media message:', error);
                throw error;
            }
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>